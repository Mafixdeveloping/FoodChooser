<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <title>FoodChooser</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .hidden { display: none; }
        .meal-list { margin-bottom: 2em; }
        .meal-type { font-weight: bold; margin-top: 1em; }
        .meal-entry { margin-left: 1em; }
        button { margin-top: 0.5em; }
        select, input[type="text"] { margin-right: 0.5em; }
        .message { color: #d00; margin-top: 1em; font-weight: bold; }
        .message.success { color: #080; }
    </style>
</head>
<body>
    <div id="page-index">
        <h1>FoodChooser start page</h1>
        <button onclick="showPage('random_meal')">Generate 3 meal ideas.</button>
        <button onclick="showPage('meals_db')">Edit the meal lists.</button>
    </div>
    <h2>Warning: If you delete your cookie, you will loose all your meals!</h2>
    <div id="page-meals_db" class="hidden">
        <h1>Meals Database</h1>
        <form id="addMealForm">
            <input type="text" name="meal_name" placeholder="Meal Name" required>
            <select name="meal_type" required>
                <option value="breakfast">Breakfast</option>
                <option value="breakfast_special">Breakfast Special</option>
                <option value="lunch">Lunch</option>
                <option value="lunch_special">Lunch Special</option>
                <option value="noon">Noon</option>
                <option value="noon_special">Noon Special</option>
                <option value="dinner">Dinner</option>
                <option value="dinner_special">Dinner Special</option>
            </select>
            <button type="submit">Add Meal</button>
        </form>
        <form id="deleteMealForm" style="margin-top:10px;">
            <input type="text" name="meal_name" placeholder="Meal Name to Delete" required>
            <select name="meal_type" required>
                <option value="breakfast">Breakfast</option>
                <option value="breakfast_special">Breakfast Special</option>
                <option value="lunch">Lunch</option>
                <option value="lunch_special">Lunch Special</option>
                <option value="noon">Noon</option>
                <option value="noon_special">Noon Special</option>
                <option value="dinner">Dinner</option>
                <option value="dinner_special">Dinner Special</option>
            </select>
            <button type="submit">Delete Meal</button>
        </form>
        <div id="deleteMessage" class="message"></div>
        <h2>Meal List</h2>
        <div id="mealLists"></div>
        <br>
        <a href="#" onclick="showPage('index'); return false;">Back to start page</a>
    </div>
    <div id="page-random_meal" class="hidden">
        <h1>Random Meal generator</h1>
        <form id="generateMealsForm">
            <select name="meal_type" required>
                <option value="breakfast">Breakfast</option>
                <option value="breakfast_special">Breakfast Special</option>
                <option value="lunch">Lunch</option>
                <option value="lunch_special">Lunch Special</option>
                <option value="noon">Noon</option>
                <option value="noon_special">Noon Special</option>
                <option value="dinner">Dinner</option>
                <option value="dinner_special">Dinner Special</option>
            </select>
            <button type="submit">Generate 3 meal ideas.</button>
        </form>
        <br>
        <h2>Generated Meal Ideas:</h2>
        <div id="randomized_result"></div>
        <br>
        <a href="#" onclick="showPage('index'); return false;">Back to start page</a>
    </div>

    <script>
        const defaultData = {
            breakfast: ["Toast", "Müsli", "Croissant"],
            breakfast_special: ["Pancakes", "Omelette"],
            lunch: ["Salat", "Suppe", "Nudeln"],
            lunch_special: ["Pizza", "Lasagne"],
            noon: ["Sandwich", "Wrap"],
            noon_special: ["Burger", "Hotdog"],
            dinner: ["Spaghetti", "Risotto", "Käseplatte"],
            dinner_special: ["Steak", "Sushi"]
        };

        function setCookie(name, value, days=365) {
            const expires = new Date(Date.now() + days*864e5).toUTCString();
            document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + "; expires=" + expires + "; path=/";
        }
        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? JSON.parse(decodeURIComponent(parts[1])) : r
            }, undefined);
        }
        function loadMeals() {
            let meals = getCookie("meals");
            if (!meals) {
                setCookie("meals", defaultData);
                return {...defaultData};
            }
            return meals;
        }
        function saveMeals(meals) {
            setCookie("meals", meals);
            // Debug: Zeigt den aktuellen Cookie-Inhalt nach jedem Speichern
            console.log("Cookie 'meals' nach speichern:", meals);
        }
        function showPage(page) {
            for (const div of ['index', 'meals_db', 'random_meal']) {
                document.getElementById('page-' + div).classList.add('hidden');
            }
            document.getElementById('page-' + page).classList.remove('hidden');
            if (page === 'meals_db') renderMealLists();
        }
        function renderMealLists() {
            const meals = loadMeals();
            let html = '';
            for (const key of Object.keys(meals)) {
                html += `<div class="meal-type">${capitalize(key)}:</div>`;
                html += `<div class="meal-list" id="list-${key}">`;
                for (const meal of meals[key]) {
                    html += `<div class="meal-entry">- ${meal}</div>`;
                }
                html += `</div>`;
            }
            document.getElementById("mealLists").innerHTML = html;
        }
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1).replace("_", " ");
        }

        document.getElementById("addMealForm").onsubmit = function(e) {
            e.preventDefault();
            const form = e.target;
            const meal_type = form.meal_type.value;
            const meal_name = form.meal_name.value.trim();
            if (!meal_name) return;
            const meals = loadMeals();
            const normalizedMealName = meal_name.trim().toLowerCase();
            if (!meals[meal_type].map(m => m.trim().toLowerCase()).includes(normalizedMealName))
                meals[meal_type].push(meal_name);
            saveMeals(meals);
            form.reset();
            renderMealLists();
        };

        document.getElementById("deleteMealForm").onsubmit = function(e) {
            e.preventDefault();
            const form = e.target;
            const meal_type = form.meal_type.value;
            const meal_name_input = form.meal_name.value.trim().toLowerCase();

            if (!meal_name_input) {
                showDeleteMessage("Bitte einen Mahlzeitennamen eingeben!", true);
                return;
            }

            let meals = loadMeals();
            let list = Array.isArray(meals[meal_type]) ? meals[meal_type] : [];

            // Finde Index des gesuchten Elements (case-insensitive, trim)
            let foundIdx = list.findIndex(m => m.trim().toLowerCase() === meal_name_input);

            if (foundIdx >= 0) {
                // Entferne nur das eine Element!
                list.splice(foundIdx, 1);
                meals[meal_type] = list;
                saveMeals(meals);
                renderMealLists();
                form.reset();
                showDeleteMessage(`"${meal_name_input}" wurde erfolgreich aus ${capitalize(meal_type)} entfernt!`, false);
            } else {
                showDeleteMessage(`"${meal_name_input}" wurde in ${capitalize(meal_type)} nicht gefunden!`, true);
            }
        };

        function showDeleteMessage(msg, isError = true) {
            let el = document.getElementById('deleteMessage');
            el.textContent = msg;
            el.className = "message" + (isError ? "" : " success");
            setTimeout(() => { el.textContent = ""; }, 4000);
        }

        document.getElementById("generateMealsForm").onsubmit = function(e) {
            e.preventDefault();
            const meal_type = e.target.meal_type.value;
            const meals = loadMeals();
            const list = (meals[meal_type] || []);
            let result = [];
            if (list.length) {
                result = shuffle(list).slice(0, Math.min(3, list.length));
            } else {
                result = ["No meals available"];
            }
            document.getElementById("randomized_result").innerHTML = result.map(m => `<div class="meal-entry">- ${m}</div>`).join('');
        };

        function shuffle(arr) {
            let a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        showPage('index');
    </script>
</body>
</html>
